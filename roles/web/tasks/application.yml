---
- name: Application - Create base directory
  file: state=directory dest={{ item.path }} owner=www-data group=www-data mode=0777 recurse=yes
  with_items: applications.sites

- name: Application - Create complete directory
  file: state=directory dest={{ item.path }}{{ item.webdir }} owner=www-data group=www-data mode=0770 recurse=yes
  with_items: applications.sites
  when: not applications.download

- name: Application - Get from GIT
  git: clone=yes dest={{ item.path }} repo={{ item.gitrepo }} force=yes update=yes
  with_items: applications.sites
  sudo_user: "{{ users.deployer.name }}"
  when: applications.download

- name: Application - Disable git filemode (handle permissions changes)
  lineinfile: dest="{{ item.path }}/.git/config" regexp="^\s*filemode\s*=\s*" line="  filemode = false"
  with_items: applications.sites
  when: applications.download

- name: Application - Change owner and group
  file: state=directory dest={{ item.path }} recurse=yes owner=www-data group=www-data
  with_items: applications.sites

- name: Application - Permissions for directories
  command: find {{ item.path }} -type d -exec chmod 0770 {} \;
  with_items: applications.sites

- name: Application - Premissions for files
  command: find {{ item.path }} -type f -exec chmod 0760 {} \;
  with_items: applications.sites

- name: Download composer installer
  get_url: url=https://getcomposer.org/installer dest={{ item.path }}/composer-setup.php
  with_items: applications.sites
  when: item.composer

- name: Install composer
  command: php {{ item.path }}/composer-setup.php --install-dir {{ item.path }}
  args:
    creates: "{{ item.path }}/composer.phar"
  sudo_user: www-data
  with_items: applications.sites
  when: item.composer

- name: Remove installer composer
  file: path={{ item.path }}/composer-setup.php state=absent
  with_items: applications.sites
  when: item.composer