---
- name: Adminer - Create adminer path
  file: state=directory path={{ adminer.path }} owner=www-data group=www-data mode=0750

- name: Adminer - Download adminer
  get_url: url=https://www.adminer.org/latest.php dest={{ adminer.path }}index.php mode=0644 force=yes timeout=15

- name: Adminer - Download adminer style
  get_url: url=https://raw.githubusercontent.com/vrana/adminer/master/designs/brade/adminer.css dest={{ adminer.path }}adminer.css mode=0644 force=yes timeout=15

- name: Adminer - Add to apache
  template: src=etc/apache2/sites-available/adminer.j2 dest=/etc/apache2/sites-available/020-{{ mariadb.domain }}.conf mode=0644 owner=root group=root
  notify:
    - restart apache2
  when: apache.enabled

- name: Adminer - Activate adminer webapp
  command: a2ensite 020-{{ mariadb.domain }} creates=/etc/apache2/sites-enabled/020-{{ mariadb.domain }}.conf
  notify:
    - restart apache2
  when: apache.enabled

- name: Adminer - Set adminer domain name in hosts
  lineinfile: dest=/etc/hosts state=present regexp=".*#\s*Adminer\s*$" line="127.0.0.1    {{ mariadb.domain }} {{ '#' }} Adminer"

- name: Adminer - Authorize adminer in PHP openbasedir
  lineinfile: dest={{ item }} state=present regexp='^(\s*;?\s*open_basedir\s*=\s*\")((?![^\"]*{{ adminer.path }}[^\"]*)[^\"]*)(\")$' line='\1\2:{{ adminer.path }}\3' backrefs=yes
  with_items:
    - /etc/php/7.0/cli/php.ini
    - /etc/php/7.0/apache2/php.ini
  notify:
    - restart apache2
  when: apache.enabled